<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樹藝現場重量評估 - 修正版</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
        .section { margin-bottom: 20px; }
        .label { font-weight: bold; margin-bottom: 8px; display: block; border-left: 4px solid var(--primary); padding-left: 8px; }
        /* 確保按鈕區塊有顯示 */
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin: 10px 0; min-height: 40px; }
        button { padding: 12px 5px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        button.active { background: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .source-box { background: #f0f4f0; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; display: none; border: 1px dashed var(--primary); }
        .result-card { background: #e8f5e9; padding: 20px; border-radius: 12px; text-align: center; margin-top: 20px; border: 2px solid var(--primary); }
        .weight-value { font-size: 2.2rem; font-weight: 900; color: var(--primary); display: block; margin: 5px 0; }
        a { color: #1b5e20; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h2>樹藝現場重量評估</h2>

    <div class="section">
        <span class="label">1. 選擇樹種 (依密度由重到輕)</span>
        <div id="quick-grid" class="btn-grid">
            </div>
        
        <span class="label" style="margin-top:15px; border-left-color: #666;">其他常用樹種 (下拉選單)</span>
        <select id="other-species" onchange="selectFromDropdown()">
            <option value="">-- 請選擇其他樹種 --</option>
        </select>

        <div id="source-info" class="source-box">
            <div><strong>推估生材密度：</strong> <span id="dens-val"></span> kg/m³</div>
            <div><strong>參考出處：</strong> <a id="source-link" href="#" target="_blank">讀取中...</a></div>
        </div>
    </div>

    <div class="section">
        <span class="label">2. 輸入直徑 (cm)</span>
        <div class="btn-grid">
            <button class="dia-btn" onclick="setDia(30, this)">30 cm</button>
            <button class="dia-btn" onclick="setDia(40, this)">40 cm</button>
            <button class="dia-btn" onclick="setDia(60, this)">60 cm</button>
            <button class="dia-btn" onclick="setDia(80, this)">80 cm</button>
        </div>
        <input type="number" id="custom-dia" placeholder="自填直徑 (cm)" oninput="clearActive('dia-btn'); calculate();">
    </div>

    <div class="section">
        <span class="label">3. 輸入長度 (m)</span>
        <div class="btn-grid">
            <button class="len-btn" onclick="setLen(0.5, this)">0.5 米</button>
            <button class="len-btn" onclick="setLen(1, this)">1 米</button>
            <button class="len-btn" onclick="setLen(2, this)">2 米</button>
        </div>
        <input type="number" id="custom-len" placeholder="自填長度 (m)" oninput="clearActive('len-btn'); calculate();">
    </div>

    <div class="result-card">
        <div>預估生材總重區間</div>
        <span class="weight-value" id="result-text">--- kg</span>
        <div id="calc-detail" style="font-size: 14px; color: #555;">請完成上方選取</div>
    </div>
</div>

<script>
    const REF_TFRI = "https://www.tfri.gov.tw/"; 
    const REF_MANUAL = "https://ws.tycg.gov.tw/001/Upload/115/relfile/13461/985280/20230323152102.pdf"; 

    // 1. 快速選單：依密度高標降冪 (1200 -> 750)
    const quickData = [
        { name: "相思樹", low: 1100, high: 1200, src: "林試所-國產材物理性質", url: REF_TFRI },
        { name: "樟樹", low: 900, high: 1000, src: "林試所-主要木材理學試驗", url: REF_TFRI },
        { name: "榕樹/菩提", low: 900, high: 1000, src: "都市樹木固碳能力推估", url: "https://tdr.lib.ntu.edu.tw/" },
        { name: "楓香", low: 850, high: 950, src: "林試所-平地造林樹種生長", url: REF_TFRI },
        { name: "肖楠/紅檜", low: 800, high: 950, src: "林試所-國產材資料庫", url: REF_TFRI },
        { name: "苦楝/桃花心木", low: 750, high: 850, src: "林試所-木材性質試驗", url: REF_TFRI },
        { name: "黑板樹", low: 600, high: 750, src: "桃園市樹木施工手冊", url: REF_MANUAL }
    ];

    // 2. 下拉選單：依密度高標降冪 (1150 -> 950)
    const otherData = [
        { name: "台灣欒樹", low: 1000, high: 1150, src: "林試所-平地造林重要樹種", url: REF_TFRI },
        { name: "烏心石", low: 900, high: 1100, src: "林試所-平地造林重要樹種", url: REF_TFRI },
        { name: "茄苳", low: 900, high: 1100, src: "林試所-平地造林重要樹種", url: REF_TFRI },
        { name: "黃連木", low: 1000, high: 1100, src: "林試所-國產材性質", url: REF_TFRI },
        { name: "大花紫薇", low: 900, high: 1050, src: "環境部-核定樹種介紹", url: "https://freshair.moenv.gov.tw/" },
        { name: "水黃皮", low: 900, high: 1050, src: "環境部-空氣品質淨化區資料", url: "https://freshair.moenv.gov.tw/" },
        { name: "大葉山欖", low: 900, high: 1050, src: "都市樹木固碳資料庫", url: "https://tech.ardswc.gov.tw/" },
        { name: "小葉欖仁", low: 900, high: 1000, src: "林試所-小葉欖仁強度性質", url: REF_TFRI },
        { name: "光蠟樹", low: 900, high: 1000, src: "林試所-平地造林利用", url: REF_TFRI },
        { name: "阿勃勒", low: 850, high: 950, src: "都市林原生樹種現況展望", url: REF_TFRI }
    ];

    let currentSpec = null;

    // 啟動函數：確保按鈕被產出
    function init() {
        const grid = document.getElementById('quick-grid');
        grid.innerHTML = ""; // 先清空
        quickData.forEach(s => {
            const btn = document.createElement('button');
            btn.innerText = s.name;
            btn.className = 'spec-btn';
            btn.onclick = () => {
                document.querySelectorAll('.spec-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('other-species').value = ""; 
                btn.classList.add('active');
                updateSpec(s);
            };
            grid.appendChild(btn);
        });

        const select = document.getElementById('other-species');
        otherData.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.name;
            opt.innerText = `${s.name} (${s.high} kg/m³)`;
            select.appendChild(opt);
        });
    }

    function selectFromDropdown() {
        const val = document.getElementById('other-species').value;
        if (!val) return;
        document.querySelectorAll('.spec-btn').forEach(b => b.classList.remove('active'));
        const s = otherData.find(x => x.name === val);
        updateSpec(s);
    }

    function updateSpec(s) {
        currentSpec = s;
