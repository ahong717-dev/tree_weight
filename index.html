<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樹藝現場重量評估 - 穩定降冪版</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
        .section { margin-bottom: 20px; }
        .label { font-weight: bold; margin-bottom: 8px; display: block; border-left: 4px solid var(--primary); padding-left: 8px; }
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin: 10px 0; }
        button { padding: 12px 5px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        button.active { background: var(--primary) !important; color: white !important; border-color: var(--primary) !important; font-weight: bold; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: white; }
        .source-box { background: #f0f4f0; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; display: none; border: 1px dashed var(--primary); line-height: 1.5; }
        .result-card { background: #e8f5e9; padding: 20px; border-radius: 12px; text-align: center; margin-top: 20px; border: 2px solid var(--primary); }
        .weight-value { font-size: 2.5rem; font-weight: 900; color: var(--primary); display: block; margin: 5px 0; }
        a { color: #1b5e20; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h2>樹藝現場重量評估</h2>

    <div class="section">
        <span class="label">1. 選擇樹種 (依密度降冪排列)</span>
        <div class="btn-grid">
            <button class="spec-btn" onclick="setSpec('相思樹', 1100, 1200, '林試所-國產材物理性質', 'https://www.tfri.gov.tw/', this)">相思樹</button>
            <button class="spec-btn" onclick="setSpec('樟樹', 900, 1000, '林試所-主要木材性質', 'https://www.tfri.gov.tw/', this)">樟樹</button>
            <button class="spec-btn" onclick="setSpec('榕樹/菩提', 900, 1000, '都市樹木固碳推估', 'https://tdr.lib.ntu.edu.tw/', this)">榕樹/菩提</button>
            <button class="spec-btn" onclick="setSpec('楓香', 850, 950, '林試所-平地造林生長', 'https://www.tfri.gov.tw/', this)">楓香</button>
            <button class="spec-btn" onclick="setSpec('肖楠/紅檜', 800, 950, '林試所-國產材資料庫', 'https://www.tfri.gov.tw/', this)">肖楠/紅檜</button>
            <button class="spec-btn" onclick="setSpec('苦楝', 750, 850, '林試所-木材性質試驗', 'https://www.tfri.gov.tw/', this)">苦楝</button>
            <button class="spec-btn" onclick="setSpec('黑板樹', 600, 750, '桃園市樹木施工手冊', 'https://ws.tycg.gov.tw/', this)">黑板樹</button>
        </div>
        
        <span class="label" style="margin-top:15px; border-left-color: #666;">其他常見樹種 (下拉選單)</span>
        <select id="other-species" onchange="selectFromDropdown()">
            <option value="">-- 請選擇其他樹種 --</option>
            <option value="1000,1150,林試所,https://www.tfri.gov.tw/,台灣欒樹">台灣欒樹 (1150 kg/m³)</option>
            <option value="900,1100,林試所,https://www.tfri.gov.tw/,烏心石">烏心石 (1100 kg/m³)</option>
            <option value="900,1100,林試所,https://www.tfri.gov.tw/,茄苳">茄苳 (1100 kg/m³)</option>
            <option value="1000,1100,林試所,https://www.tfri.gov.tw/,黃連木">黃連木 (1100 kg/m³)</option>
            <option value="900,1050,環境部,https://freshair.moenv.gov.tw/,大花紫薇">大花紫薇 (1050 kg/m³)</option>
            <option value="900,1050,環境部,https://freshair.moenv.gov.tw/,水黃皮">水黃皮 (1050 kg/m³)</option>
            <option value="900,1050,環境部,https://tech.ardswc.gov.tw/,大葉山欖">大葉山欖 (1050 kg/m³)</option>
            <option value="900,1000,林試所,https://www.tfri.gov.tw/,小葉欖仁">小葉欖仁 (1000 kg/m³)</option>
            <option value="900,1000,林試所,https://www.tfri.gov.tw/,光蠟樹">光蠟樹 (1000 kg/m³)</option>
            <option value="850,950,林試所,https://www.tfri.gov.tw/,阿勃勒">阿勃勒 (950 kg/m³)</option>
        </select>

        <div id="source-info" class="source-box">
            <div><strong>推估生材密度：</strong> <span id="dens-val"></span> kg/m³</div>
            <div><strong>參考出處：</strong> <a id="source-link" href="#" target="_blank"></a></div>
        </div>
    </div>

    <div class="section">
        <span class="label">2. 輸入直徑 (cm)</span>
        <div class="btn-grid">
            <button class="dia-btn" onclick="setDia(30, this)">30 cm</button>
            <button class="dia-btn" onclick="setDia(40, this)">40 cm</button>
            <button class="dia-btn" onclick="setDia(60, this)">60 cm</button>
            <button class="dia-btn" onclick="setDia(80, this)">80 cm</button>
        </div>
        <input type="number" id="custom-dia" placeholder="自填直徑 (cm)" oninput="clearDiaActive(); calculate();">
    </div>

    <div class="section">
        <span class="label">3. 輸入長度 (m)</span>
        <div class="btn-grid">
            <button class="len-btn" onclick="setLen(0.5, this)">0.5 米</button>
            <button class="len-btn" onclick="setLen(1, this)">1 米</button>
            <button class="len-btn" onclick="setLen(2, this)">2 米</button>
        </div>
        <input type="number" id="custom-len" placeholder="自填長度 (m)" oninput="clearLenActive(); calculate();">
    </div>

    <div class="result-card">
        <div>預估生材總重區間</div>
        <span class="weight-value" id="result-text">--- kg</span>
        <div id="calc-detail" style="font-size: 14px; color: #555;">請完成上方選取</div>
        <div style="font-size: 11px; color: #999; margin-top:10px;">公式：$V = \pi \times r^2 \times L$</div>
    </div>
</div>

<script>
    let currentLow = 0, currentHigh = 0, currentName = "";

    function setSpec(name, low, high, src, url, btn) {
        // 重置所有樹種選擇狀態
        document.querySelectorAll('.spec-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('other-species').value = "";
        
        // 設定當前樹種
        if(btn) btn.classList.add('active');
        currentName = name;
        currentLow = low;
        currentHigh = high;

        // 顯示資訊與計算
        showInfo(low, high, src, url);
        calculate();
    }

    function selectFromDropdown() {
        const val = document.getElementById('other-species').value;
        if (!val) return;
        
        // 取消按鈕高亮
        document.querySelectorAll('.spec-btn').forEach(b => b.classList.remove('active'));
        
        // 解析資料 (格式: low,high,src,url,name)
        const parts = val.split(',');
        currentLow = parseInt(parts[0]);
        currentHigh = parseInt(parts[1]);
        currentName = parts[4];
        
        showInfo(currentLow, currentHigh, parts[2], parts[3]);
        calculate();
    }

    function showInfo(low, high, src, url) {
        document.getElementById('source-info').style.display = 'block';
        document.getElementById('dens-val').innerText = low + " ~ " + high;
        const link = document.getElementById('source-link');
        link.innerText = src;
        link.href = url;
    }

    function setDia(v, btn) {
        document.querySelectorAll('.dia-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('custom-dia').value = v;
        calculate();
    }

    function setLen(v, btn) {
        document.querySelectorAll('.len-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('custom-len').value = v;
        calculate();
    }

    function clearDiaActive() { document.querySelectorAll('.dia-btn').forEach(b => b.classList.remove('active')); }
    function clearLenActive() { document.querySelectorAll('.len-btn').forEach(b => b.classList.remove('active')); }

    function calculate() {
        const d = parseFloat(document.getElementById('custom
